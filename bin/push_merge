#!/bin/sh

if branch=$(git rev-parse --abbrev-ref HEAD) &&
  upstream=$(git rev-parse --abbrev-ref @{upstream}); then
  git checkout -B "${branch}-squashed"
  git reset --soft $upstream
  (
    upstream_rev=$(git rev-parse --short $upstream)
    branch_rev=$(git rev-parse --short $branch)
    echo "Squash of $upstream($upstream_rev)..$branch($branch_rev) (DO NOT SUBMIT)"
    echo
    git shortlog -w72,1,3 --format='- %s' "${upstream}..${branch}"
  ) | git commit -q -F -
  # Give it a Change-Id
  (
    git cat-file commit HEAD | sed -e '1,/^$/d'
    echo
    echo "Change-Id: I$(git rev-parse HEAD)"
  ) | git commit -q -F - --amend
  git diff --exit-code "$branch" || echo "Something went wrong!"
  lineage-push -t android-9.0.0_r31 lineage-16.0
  git checkout $branch
fi
